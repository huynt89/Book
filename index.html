<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸ“š Kho Truyá»‡n Tranh Cá»§a TÃ´i</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin:0; padding:0; background:#f4f4f9; color:#333; }
        header { background:#3498db; color:#fff; padding:20px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.1); position:relative; }
        .back-link { position:absolute; left:20px; top:25px; color:#fff; text-decoration:none; font-weight:bold; font-size:1.1em; }
        main { max-width:1000px; margin:20px auto; padding:0 20px; }
        
        /* Button styles */
        #loadComicsBtn { background:#2ecc71; color:#fff; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; font-size:16px; transition:background .2s; }
        #loadComicsBtn:hover { background:#27ae60; }
        
        #status { margin-top:10px; font-style:italic; color:#777; }
        
        /* Comic List Grid */
        #comicsContainer { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap:20px; margin-top:20px; }
        .comic-item { background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.05); overflow:hidden; transition:transform .2s; }
        .comic-item:hover { transform:translateY(-5px); }
        .comic-item a { display:block; padding:15px; text-decoration:none; color:inherit; }
        .comic-item h3 { color:#3498db; margin:0 0 5px 0; }
        
        /* Viewer & Pages */
        #viewerContainer { text-align:center; padding:20px 0; margin-top: 20px; }
        .comic-page { max-width:100%; height:auto; display:block; margin:0 auto 10px auto; border:1px solid #ddd; box-shadow:0 4px 8px rgba(0,0,0,.1); }
        .view-link { color:#e74c3c; font-weight:bold; margin-top:10px !important; }
        
        footer { text-align:center; padding:10px; background:#ecf0f1; color:#777; margin-top:30px; border-top:1px solid #ddd; }
        
        /* áº¨n cÃ¡c box lá»—i lÃ²e loáº¹t, chá»‰ giá»¯ láº¡i text Ä‘Æ¡n giáº£n náº¿u cáº§n */
        .error { color:#c0392b; text-align:center; font-weight: bold; }
        
        /* Debug Box */
        #debugInfo { 
            background: #333; color: #0f0; font-family: monospace; padding: 10px; 
            margin-top: 10px; border-radius: 5px; font-size: 12px; text-align: left;
            display: none; white-space: pre-wrap;
        }

        /* Sticky Controls */
        .chapter-controls-wrapper {
            position: sticky; top: 0; z-index: 1000; 
            background: #fff; border-bottom: 1px solid #ddd;
            padding: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,.1);
        }
        .chapter-controls { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
        .chapter-controls select { padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
        .chapter-controls button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; color:#fff; background:#2b78c8; }
        .chapter-controls button.green { background:#2ecc71; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" id="backLink" style="display:none;" class="back-link">&larr; Quay láº¡i Danh sÃ¡ch</a>
        <h1 id="mainTitle">Truyá»‡n Tranh Online</h1>
        <p id="subText">Kho lÆ°u trá»¯ truyá»‡n tranh cÃ¡ nhÃ¢n trÃªn GitHub</p>
    </header>

    <main>
        <div id="controls">
            <button id="loadComicsBtn">ğŸ”„ Táº£i Danh SÃ¡ch Truyá»‡n</button>
            <p id="status"></p>
        </div>

        <section id="comicList">
            <h2>Danh SÃ¡ch Truyá»‡n</h2>
            <div id="comicsContainer">
                <p>Nháº¥n nÃºt <strong>Táº£i Danh SÃ¡ch Truyá»‡n</strong> Ä‘á»ƒ báº¯t Ä‘áº§u.</p>
            </div>
        </section>
        
        <section id="comicViewer" style="display:none;">
            <div class="chapter-controls-wrapper"> 
                <div class="chapter-controls" id="chapterControls">
                    <label for="chapterSelect">Chá»n Chap:</label>
                    <select id="chapterSelect"></select>
                    <button id="loadChapterBtn" class="green">Load Chapter</button>
                    <button id="reloadBtn">Reload Images</button>
                </div>
                <div id="apiStatus" style="text-align: center; font-size: 0.9em; color: #e67e22; margin-top:5px;"></div>
            </div>
            
            <div id="debugInfo"></div>
            <div id="viewerContainer"></div>
        </section>
    </main>

    <footer><p>&copy; 2025 Web Truyá»‡n GitHub</p></footer>

<script>
/* ================= Cáº¤U HÃŒNH ================= */
const GITHUB_CONFIG = {
Â  Â  OWNER: 'huynt89',
Â  Â  REPO: 'Book',Â  Â  Â  Â 
Â  Â  ROOT_DIR: '',Â  Â  Â  Â 
Â  Â  COMIC_DIR: 'Comic'Â Â 
};

const COMIC_DATA_JSON = [
Â  Â  {
Â  Â  Â  Â  "title": "Truyá»‡n Yugi-Oh",
Â  Â  Â  Â  "folder": "YugiOh",Â 
Â  Â  Â  Â  "upload_date": "2025-11-16",
Â  Â  Â  Â  "description": "Vua TrÃ² ChÆ¡i Yugi-Oh"
Â  Â  }
];

/* ================= HÃ€M Há»– TRá»¢ PATH ================= */
function getBaseImagePath() {
Â  Â  const origin = window.location.origin;Â 
Â  Â  const pathname = window.location.pathname;
Â  Â  if(pathname.includes('/Book/')) return origin + '/Book/';
Â  Â  return origin + pathname.substring(0, pathname.lastIndexOf('/') + 1);
}
const BASE_PATH = getBaseImagePath();

/* ================= KHá»I Táº O & CONTROLS ================= */
let currentComicBase = '';
let currentChapterPath = '';

document.addEventListener('DOMContentLoaded', initializePage);

function initializePage() {
Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const folderParam = params.get('folder');Â 
Â  Â  
Â  Â  // áº¨n nÃºt "Load Chapter" vÃ  chá»‰ hiá»ƒn thá»‹ "Reload Images"
Â  Â  const loadChapterBtn = document.getElementById('loadChapterBtn');
Â  Â  if (loadChapterBtn) loadChapterBtn.style.display = 'none'; 
Â  Â  
Â  Â  // Báº¯t sá»± kiá»‡n khi thay Ä‘á»•i chapter
Â  Â  const chapterSelect = document.getElementById('chapterSelect');
Â  Â  chapterSelect.addEventListener('change', (e) => {
Â  Â  Â  Â  const selectedChapter = e.target.value;
Â  Â  Â  Â  if (currentComicBase && selectedChapter) {
Â  Â  Â  Â  Â  Â  loadComicPagesFast(`${currentComicBase}/${selectedChapter}`);
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  // Báº¯t sá»± kiá»‡n Reload Images
Â  Â  document.getElementById('reloadBtn').onclick = reloadFailedImages;

Â  Â  if (folderParam) {
Â  Â  Â  Â  showViewerPage(decodeURIComponent(folderParam));
Â  Â  } else {
Â  Â  Â  Â  showListPage();
Â  Â  }
}

/* ================= LIST PAGE ================= */
function showListPage() {
Â  Â  document.getElementById('backLink').style.display = 'none';
Â  Â  document.getElementById('mainTitle').textContent = 'Truyá»‡n Tranh Online';
Â  Â  document.getElementById('comicViewer').style.display = 'none';
Â  Â  document.getElementById('comicList').style.display = 'block';
Â  Â  document.getElementById('controls').style.display = 'block';

Â  Â  const loadBtn = document.getElementById('loadComicsBtn');
Â  Â  loadBtn.removeEventListener('click', loadComics);
Â  Â  loadBtn.addEventListener('click', loadComics);
Â  Â  loadComics();Â 
}

function loadComics() {
Â  Â  const comicsContainer = document.getElementById('comicsContainer');
Â  Â  const statusEl = document.getElementById('status');
Â  Â  const comics = COMIC_DATA_JSON;
Â  Â  comicsContainer.innerHTML = '';
Â  Â Â 
Â  Â  comics.forEach(comic => {
Â  Â  Â  Â  const comicDiv = document.createElement('div');
Â  Â  Â  Â  comicDiv.classList.add('comic-item');
Â  Â  Â  Â  const comicLink = document.createElement('a');
Â  Â  Â  Â  comicLink.href = `index.html?folder=${encodeURIComponent(comic.folder)}`;
Â  Â  Â  Â  comicLink.innerHTML = `
Â  Â  Â  Â  Â  Â  <h3>${comic.title}</h3>
Â  Â  Â  Â  Â  Â  <p>${comic.description}</p>
Â  Â  Â  Â  Â  Â  <p class="view-link">Xem ngay &rarr;</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  comicDiv.appendChild(comicLink);
Â  Â  Â  Â  comicsContainer.appendChild(comicDiv);
Â  Â  });
Â  Â  statusEl.textContent = `âœ… ÄÃ£ táº£i: ${comics.length} truyá»‡n.`;
}

/* ================= VIEWER PAGE (INIT) ================= */
async function showViewerPage(folderParam) {
Â  Â  document.getElementById('controls').style.display = 'none';
Â  Â  document.getElementById('comicList').style.display = 'none';
Â  Â  document.getElementById('comicViewer').style.display = 'block';
Â  Â  document.getElementById('backLink').style.display = 'block';

Â  Â  const parts = folderParam.split('/').filter(Boolean);
Â  Â  currentComicBase = parts[0];Â  // LÆ°u láº¡i comic base
Â  Â  const initialChapter = parts.length > 1 ? parts.slice(1).join('/') : '';

Â  Â  const currentComic = COMIC_DATA_JSON.find(c => c.folder === currentComicBase);
Â  Â  document.getElementById('mainTitle').textContent = currentComic ? currentComic.title : currentComicBase;

Â  Â  const chapterSelect = document.getElementById('chapterSelect');
Â  Â  const apiStatus = document.getElementById('apiStatus');
Â  Â Â 
Â  Â  chapterSelect.innerHTML = '<option>Äang tÃ¬m Chap...</option>';
Â  Â  apiStatus.textContent = 'Äang káº¿t ná»‘i...';

Â  Â  const path = [GITHUB_CONFIG.ROOT_DIR, GITHUB_CONFIG.COMIC_DIR, currentComicBase].filter(p => p).join('/');
Â  Â  const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${path}`;

Â  Â  let chapters = [];

Â  Â  try {
Â  Â  Â  Â  const res = await fetch(apiUrl);
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  throw new Error("Lá»—i káº¿t ná»‘i API");Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  const items = await res.json();
Â  Â  Â  Â  chapters = items
Â  Â  Â  Â  Â  Â  .filter(item => item.type === 'dir')
Â  Â  Â  Â  Â  Â  .map(item => item.name)
Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const numA = parseInt((a.match(/\d+/) || [0])[0]);
Â  Â  Â  Â  Â  Â  Â  Â  const numB = parseInt((b.match(/\d+/) || [0])[0]);
Â  Â  Â  Â  Â  Â  Â  Â  return numA - numB;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  apiStatus.textContent = '';Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  apiStatus.innerHTML = ``;
Â  Â  }

Â  Â  chapterSelect.innerHTML = '';Â 

Â  Â  if (chapters.length > 0) {
Â  Â  Â  Â  chapters.forEach(ch => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = ch;
Â  Â  Â  Â  Â  Â  opt.textContent = ch;
Â  Â  Â  Â  Â  Â  chapterSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  let chapterToLoad = chapters[0];
Â  Â  Â  Â  if (initialChapter && chapters.includes(initialChapter)) {
Â  Â  Â  Â  Â  Â  chapterSelect.value = initialChapter;
Â  Â  Â  Â  Â  Â  chapterToLoad = initialChapter;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  chapterSelect.selectedIndex = 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  // â­ï¸ Tá»± Ä‘á»™ng load chapter khi khá»Ÿi táº¡o
Â  Â  Â  Â  loadComicPagesFast(`${currentComicBase}/${chapterToLoad}`);
Â  Â  } else {
Â  Â  Â  Â  const defaultChap = initialChapter || 'Chap1';
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = defaultChap;
Â  Â  Â  Â  opt.textContent = `${defaultChap} (Máº·c Ä‘á»‹nh)`;
Â  Â  Â  Â  chapterSelect.appendChild(opt);
Â  Â  Â  Â  loadComicPagesFast(`${currentComicBase}/${defaultChap}`);
Â  Â  }
}


/* ================= LOAD áº¢NH Báº°NG API (KHÃ”NG DÃ™NG VÃ’NG Láº¶P ÄOÃN) ================= */
async function loadComicPagesFast(folderPath) {
    currentChapterPath = folderPath; // LÆ°u láº¡i path cá»§a chapter hiá»‡n táº¡i
Â  Â  const viewer = document.getElementById('viewerContainer');
Â  Â  const statusViewerEl = createOrGetStatusElement(viewer);
Â  Â  viewer.innerHTML = ''; // XÃ³a háº¿t áº£nh cÅ©
Â  Â  viewer.appendChild(statusViewerEl);
    
Â  Â  statusViewerEl.textContent = 'ğŸš€ Äang táº£i danh sÃ¡ch áº£nh...';

Â  Â  const [comicBase, chapterFolder] = folderPath.split('/');
Â  Â  const fullPath = [GITHUB_CONFIG.ROOT_DIR, GITHUB_CONFIG.COMIC_DIR, comicBase, chapterFolder].filter(p => p).join('/');
Â  Â  const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${fullPath}`;

Â  Â  try {
Â  Â  Â  Â  const res = await fetch(apiUrl);
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`GitHub API Error: ${res.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const items = await res.json();
Â  Â  Â  Â  
Â  Â  Â  Â  // 1. Lá»c vÃ  Sáº¯p xáº¿p tÃªn file áº£nh
Â  Â  Â  Â  const imageFiles = items
Â  Â  Â  Â  Â  Â  .filter(item => item.type === 'file' && (item.name.endsWith('.jpg') || item.name.endsWith('.png')))
Â  Â  Â  Â  Â  Â  .map(item => item.name)
Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const numA = parseInt(a.match(/\d+/)?.[0] || '0');
Â  Â  Â  Â  Â  Â  Â  Â  const numB = parseInt(b.match(/\d+/)?.[0] || '0');
Â  Â  Â  Â  Â  Â  Â  Â  return numA - numB;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  if (imageFiles.length === 0) {
Â  Â  Â  Â  Â  Â  statusViewerEl.textContent = 'KhÃ´ng tÃ¬m tháº¥y báº¥t ká»³ file áº£nh nÃ o trong chÆ°Æ¡ng nÃ y (.jpg hoáº·c .png).';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Táº¡o URL cÆ¡ sá»Ÿ vÃ  hiá»ƒn thá»‹ áº£nh
Â  Â  Â  Â  const baseContentUrl = `${BASE_PATH}${GITHUB_CONFIG.COMIC_DIR}/${folderPath}/`;
Â  Â  Â  Â  
Â  Â  Â  Â  const fragment = document.createDocumentFragment();
Â  Â  Â  Â  imageFiles.forEach((fileName, index) => {
Â  Â  Â  Â  Â  Â  const imgContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  imgContainer.className = 'comic-page-container';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  img.className = 'comic-page';
Â  Â  Â  Â  Â  Â  img.alt = `Trang ${index + 1} (${fileName})`;
Â  Â  Â  Â  Â  Â  img.src = baseContentUrl + fileName;
            img.dataset.status = 'loading'; // Thiáº¿t láº­p tráº¡ng thÃ¡i ban Ä‘áº§u

            img.onload = function() {
                this.dataset.status = 'loaded';
                // XÃ³a icon lá»—i náº¿u cÃ³
                const errorIcon = this.nextElementSibling;
                if(errorIcon && errorIcon.classList.contains('error-icon')) {
                    errorIcon.remove();
                }
            };

            img.onerror = function() {
                this.dataset.status = 'failed';
                // ThÃªm icon lá»—i (X)
                let errorIcon = this.nextElementSibling;
                if (!errorIcon || !errorIcon.classList.contains('error-icon')) {
                    errorIcon = document.createElement('span');
                    errorIcon.className = 'error-icon';
                    errorIcon.textContent = 'âŒ Lá»—i táº£i áº£nh';
                    errorIcon.style.cssText = 'color: #c0392b; font-weight: bold; margin-top: 5px; display: block;';
                    this.parentNode.insertBefore(errorIcon, this.nextSibling);
                }
            };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  imgContainer.appendChild(img);
Â  Â  Â  Â  Â  Â  fragment.appendChild(imgContainer);
Â  Â  Â  Â  });

Â  Â  Â  Â  // 3. Hiá»ƒn thá»‹ táº¥t cáº£ áº£nh cÃ¹ng lÃºc
Â  Â  Â  Â  viewer.insertBefore(fragment, statusViewerEl);

Â  Â  Â  Â  // â­ï¸ XÃ³a dÃ²ng tráº¡ng thÃ¡i theo yÃªu cáº§u
Â  Â  Â  Â  statusViewerEl.textContent = ''; 

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Lá»—i khi táº£i trang báº±ng API:", e);
Â  Â  Â  Â  statusViewerEl.textContent = `âŒ Lá»—i: KhÃ´ng thá»ƒ táº£i danh sÃ¡ch file.`;
Â  Â  }
}

// HÃ m há»— trá»£ táº¡o/láº¥y status element
function createOrGetStatusElement(viewer) {
    let statusViewerEl = document.getElementById('status-viewer');
    if (!statusViewerEl) {
        statusViewerEl = document.createElement('p');
        statusViewerEl.id = 'status-viewer';
        statusViewerEl.style.color = '#777';
        statusViewerEl.style.fontStyle = 'italic';
        statusViewerEl.style.textAlign = 'center';
    }
    return statusViewerEl;
}

/* ================= CHá»¨C NÄ‚NG RELOAD Lá»–I ================= */
function reloadFailedImages() {
    const viewer = document.getElementById('viewerContainer');
    const statusViewerEl = createOrGetStatusElement(viewer);
    let failedCount = 0;
    let reloadCount = 0;
    
    // TÃ¬m táº¥t cáº£ cÃ¡c tháº» <img> cÃ³ thuá»™c tÃ­nh data-status="failed"
    const failedImages = viewer.querySelectorAll('img[data-status="failed"]');
    
    if (failedImages.length === 0) {
        statusViewerEl.textContent = 'ğŸ‰ KhÃ´ng cÃ³ áº£nh nÃ o bá»‹ lá»—i cáº§n táº£i láº¡i.';
        setTimeout(() => statusViewerEl.textContent = '', 3000);
        return;
    }

    statusViewerEl.textContent = `ğŸ”„ Äang táº£i láº¡i ${failedImages.length} áº£nh bá»‹ lá»—i...`;

    failedImages.forEach(img => {
        // Äáº·t láº¡i tráº¡ng thÃ¡i Ä‘á»ƒ kÃ­ch hoáº¡t láº¡i sá»± kiá»‡n onload/onerror
        img.dataset.status = 'loading'; 
        
        // Buá»™c trÃ¬nh duyá»‡t táº£i láº¡i áº£nh báº±ng cÃ¡ch thay Ä‘á»•i src
        const originalSrc = img.src;
        img.src = ''; 
        img.src = originalSrc; 
        reloadCount++;
    });

    if (reloadCount > 0) {
        // Cáº§n thÃªm logic Ä‘á»ƒ kiá»ƒm tra sau khi reload xong (sá»­ dá»¥ng Promise.all hoáº·c delay)
        // Hiá»‡n táº¡i, ta dÃ¹ng delay Ä‘Æ¡n giáº£n Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
        setTimeout(() => {
            const stillFailed = viewer.querySelectorAll('img[data-status="failed"]').length;
            if (stillFailed === 0) {
                statusViewerEl.textContent = `âœ… Táº£i láº¡i thÃ nh cÃ´ng!`;
            } else {
                statusViewerEl.textContent = `âš ï¸ Váº«n cÃ²n ${stillFailed} áº£nh chÆ°a táº£i Ä‘Æ°á»£c. Thá»­ láº¡i sau.`;
            }
            setTimeout(() => statusViewerEl.textContent = '', 3000); // XÃ³a status sau 3s
        }, 1500); 
    }
}


/* ================= BACK LINK ================= */
document.getElementById('backLink').addEventListener('click', function(e) {
Â  Â  e.preventDefault();
Â  Â  window.location.href = 'index.html';
});
</script>
</body>
</html>