<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  Â  <title>ğŸ“š Kho Truyá»‡n Tranh Cá»§a TÃ´i</title>
Â  Â  <style>
Â  Â  Â  Â  body { font-family: Arial, sans-serif; line-height: 1.6; margin:0; padding:0; background:#f4f4f9; color:#333; }
Â  Â  Â  Â  header { background:#3498db; color:#fff; padding:20px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.1); position:relative; }
Â  Â  Â  Â  .back-link { position:absolute; left:20px; top:25px; color:#fff; text-decoration:none; font-weight:bold; font-size:1.1em; }
Â  Â  Â  Â  main { max-width:1000px; margin:20px auto; padding:0 20px; }
Â  Â  Â  Â  #loadComicsBtn { background:#2ecc71; color:#fff; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; font-size:16px; transition:background .2s; }
Â  Â  Â  Â  #loadComicsBtn:hover { background:#27ae60; }
Â  Â  Â  Â  #status { margin-top:10px; font-style:italic; color:#777; }
Â  Â  Â  Â  #viewerContainer { text-align:center; padding:20px 0; }
Â  Â  Â  Â  #comicsContainer { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap:20px; margin-top:20px; }
Â  Â  Â  Â  .comic-item { background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.05); overflow:hidden; transition:transform .2s; }
Â  Â  Â  Â  .comic-item:hover { transform:translateY(-5px); }
Â  Â  Â  Â  .comic-item a { display:block; padding:15px; text-decoration:none; color:inherit; }
Â  Â  Â  Â  .comic-item h3 { color:#3498db; margin:0 0 5px 0; }
Â  Â  Â  Â  .comic-page { max-width:100%; height:auto; display:block; margin:0 auto 10px auto; border:1px solid #ddd; box-shadow:0 4px 8px rgba(0,0,0,.1); }
Â  Â  Â  Â  .view-link { color:#e74c3c; font-weight:bold; margin-top:10px !important; }
Â  Â  Â  Â  footer { text-align:center; padding:10px; background:#ecf0f1; color:#777; margin-top:30px; border-top:1px solid #ddd; }
Â  Â  Â  Â  .error { color:#c0392b; text-align:center; }

Â  Â  Â  Â  /* chapter controls */
Â  Â  Â  Â  .chapter-controls { display:flex; gap:10px; justify-content:center; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
Â  Â  Â  Â  .chapter-controls select { padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
Â  Â  Â  Â  .chapter-controls button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; color:#fff; background:#2b78c8; }
Â  Â  Â  Â  .chapter-controls button.green { background:#2ecc71; }
Â  Â  Â  Â  .small-note { text-align:center; color:#555; margin-bottom:6px; }
Â  Â  </style>
</head>
<body>
Â  Â  <header>
Â  Â  Â  Â  <a href="index.html" id="backLink" style="display:none;" class="back-link">&larr; Quay láº¡i Danh sÃ¡ch</a>
Â  Â  Â  Â  <h1 id="mainTitle">Truyá»‡n Tranh Online</h1>
Â  Â  Â  Â  <p id="subText">Kho lÆ°u trá»¯ truyá»‡n tranh cÃ¡ nhÃ¢n trÃªn GitHub</p>
Â  Â  </header>

Â  Â  <main>
Â  Â  Â  Â  <div id="controls">
Â  Â  Â  Â  Â  Â  <button id="loadComicsBtn">ğŸ”„ Táº£i Danh SÃ¡ch Truyá»‡n</button>
Â  Â  Â  Â  Â  Â  <p id="status"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <section id="comicList">
Â  Â  Â  Â  Â  Â  <h2>Danh SÃ¡ch Truyá»‡n</h2>
Â  Â  Â  Â  Â  Â  <div id="comicsContainer">
Â  Â  Â  Â  Â  Â  Â  Â  <p>Nháº¥n nÃºt <strong>Táº£i Danh SÃ¡ch Truyá»‡n</strong> Ä‘á»ƒ báº¯t Ä‘áº§u.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <section id="comicViewer" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="small-note" id="viewerNote">Cuá»™n xuá»‘ng Ä‘á»ƒ Ä‘á»c truyá»‡n</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chapter-controls" id="chapterControls" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="chapterSelect">Chá»n Chap:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="chapterSelect"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="loadChapterBtn" class="green">Load Chapter</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="reloadBtn">Reload Images</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="viewerContainer"></div>
Â  Â  Â  Â  </section>
Â  Â  </main>

Â  Â  <footer>
Â  Â  Â  Â  <p>&copy; 2025 Web Truyá»‡n GitHub</p>
Â  Â  </footer>

<script>
/* ================= CONFIG & DATA ================= */
const COMIC_DATA_JSON = [
Â  Â  {
Â  Â  Â  Â  "title": "Truyá»‡n Yugi-Oh",
Â  Â  Â  Â  // you can set folder to full 'YugiOh/Chap1' or just 'YugiOh' (script handles both)
Â  Â  Â  Â  "folder": "YugiOh/Chap1",
Â  Â  Â  Â  "upload_date": "2025-11-16",
Â  Â  Â  Â  "description": "MÃ´ táº£ chuyá»‡n Yugi-Oh."
Â  Â  }
Â  Â  // add more comics if needed
];

const MAX_PAGES = 2000;
const COMIC_ROOT_FOLDER = "Comic/"; // index.html náº±m trong book/, Comic náº±m cÃ¹ng cáº¥p

// derive BASE_PATH and GitHub owner/repo (assumes GitHub Pages served from username.github.io)
function getBasePath() {
Â  Â  const origin = window.location.origin; // https://huynt89.github.io
Â  Â  const path = window.location.pathname; // e.g. /Book/index.html
Â  Â  const folderPath = path.endsWith('/') ? path : path.substring(0, path.lastIndexOf('/') + 1);
Â  Â  return origin + folderPath;
}
const BASE_PATH = getBasePath();

// get owner and repo (for API). 
// **UPDATED:** To correctly handle Project Pages (e.g., huynt89.github.io/Book/)
function getGitHubOwnerRepo() {
Â  Â  // hostname is e.g. 'huynt89.github.io'
Â  Â  const host = window.location.hostname;
Â  Â  const owner = host.split('.')[0]; // e.g. 'huynt89'

Â  Â  // Get repository name from the first part of the pathname, e.g., '/Book/index.html' -> 'Book'
Â  Â  const pathParts = window.location.pathname.split('/').filter(p => p.length > 0);
Â  Â  const repo = pathParts.length > 0 ? pathParts[0] : owner + '.github.io'; // Fallback to user pages repo

Â  Â  // NOTE: The path should contain 'Book' (case-sensitive to the repo name)
Â  Â  return { owner, repo };
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', initializePage);

function initializePage() {
Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const folderParam = params.get('folder'); // may be 'YugiOh/Chap1' or 'YugiOh'
Â  Â  if (folderParam) {
Â  Â  Â  Â  showViewerPage(decodeURIComponent(folderParam));
Â  Â  } else {
Â  Â  Â  Â  showListPage();
Â  Â  }
}

/* ================= LIST PAGE ================= */
function showListPage() {
Â  Â  document.getElementById('backLink').style.display = 'none';
Â  Â  document.getElementById('mainTitle').textContent = 'Truyá»‡n Tranh Online';
Â  Â  document.getElementById('subText').textContent = 'Kho lÆ°u trá»¯ truyá»‡n tranh cÃ¡ nhÃ¢n trÃªn GitHub';
Â  Â  document.getElementById('comicViewer').style.display = 'none';
Â  Â  document.getElementById('comicList').style.display = 'block';
Â  Â  document.getElementById('controls').style.display = 'block';

Â  Â  const loadBtn = document.getElementById('loadComicsBtn');
Â  Â  loadBtn.removeEventListener('click', loadComics);
Â  Â  loadBtn.addEventListener('click', loadComics);
Â  Â  loadComics();
}

async function loadComics() {
Â  Â  const comicsContainer = document.getElementById('comicsContainer');
Â  Â  const statusEl = document.getElementById('status');
Â  Â  statusEl.textContent = 'Äang táº£i danh sÃ¡ch...';
Â  Â  try {
Â  Â  Â  Â  const comics = COMIC_DATA_JSON;
Â  Â  Â  Â  comicsContainer.innerHTML = '';
Â  Â  Â  Â  if (!comics || comics.length === 0) {
Â  Â  Â  Â  Â  Â  comicsContainer.innerHTML = '<p>KhÃ´ng tÃ¬m tháº¥y truyá»‡n nÃ o.</p>';
Â  Â  Â  Â  Â  Â  statusEl.textContent = 'ÄÃ£ táº£i: 0 truyá»‡n.';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  comics.forEach(comic => {
Â  Â  Â  Â  Â  Â  const comicDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  comicDiv.classList.add('comic-item');
Â  Â  Â  Â  Â  Â  const comicLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  comicLink.href = `index.html?folder=${encodeURIComponent(comic.folder)}`;
Â  Â  Â  Â  Â  Â  comicLink.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h3>${comic.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>NgÃ y táº£i lÃªn:</strong> ${comic.upload_date}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>${comic.description}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="view-link">Xem ngay &rarr;</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  comicDiv.appendChild(comicLink);
Â  Â  Â  Â  Â  Â  comicsContainer.appendChild(comicDiv);
Â  Â  Â  Â  });
Â  Â  Â  Â  statusEl.textContent = `âœ… ÄÃ£ táº£i: ${comics.length} truyá»‡n.`;
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  comicsContainer.innerHTML = '<p class="error">âŒ Lá»—i: KhÃ´ng thá»ƒ táº£i danh sÃ¡ch truyá»‡n.</p>';
Â  Â  Â  Â  statusEl.textContent = 'Táº£i tháº¥t báº¡i.';
Â  Â  }
}

/* ================= VIEWER PAGE =================
Â  Â - shows chapter selector (populated from GitHub API) when possible
Â  Â - Load Chapter button + Reload Images
*/
async function showViewerPage(folderParam) {
Â  Â  // folderParam may be "YugiOh/Chap1" or "YugiOh"
Â  Â  document.getElementById('controls').style.display = 'none';
Â  Â  document.getElementById('comicList').style.display = 'none';
Â  Â  document.getElementById('comicViewer').style.display = 'block';
Â  Â  document.getElementById('backLink').style.display = 'block';

Â  Â  // determine comic base and initial chapter
Â  Â  const parts = folderParam.split('/').filter(Boolean);
Â  Â  const comicBase = parts[0]; // e.g. "YugiOh"
Â  Â  const initialChapter = parts.slice(1).join('/') || ''; // e.g. "Chap1"

Â  Â  const currentComic = COMIC_DATA_JSON.find(c => c.folder.split('/')[0] === comicBase);
Â  Â  document.getElementById('mainTitle').textContent = currentComic ? currentComic.title : comicBase;
Â  Â  document.getElementById('subText').textContent = 'Cuá»™n xuá»‘ng Ä‘á»ƒ Ä‘á»c truyá»‡n';

Â  Â  // show chapter controls and try populate chapter list from GitHub API
Â  Â  const chapterControlsEl = document.getElementById('chapterControls');
Â  Â  const chapterSelect = document.getElementById('chapterSelect');
Â  Â  const loadChapterBtn = document.getElementById('loadChapterBtn');
Â  Â  const reloadBtn = document.getElementById('reloadBtn');

Â  Â  // reset viewer
Â  Â  document.getElementById('viewerContainer').innerHTML = '';
Â  Â  chapterControlsEl.style.display = 'none';
Â  Â  chapterSelect.innerHTML = '';

Â  Â  // try fetch list of directories under book/Comic/<comicBase>
Â  Â  const { owner, repo } = getGitHubOwnerRepo();
    // The path here assumes index.html is in /<repo>/index.html and the comic folder structure is /<repo>/Comic/...
Â  Â  const apiPath = `https://api.github.com/repos/${owner}/${repo}/contents/${COMIC_ROOT_FOLDER}${encodeURIComponent(comicBase)}`;

Â  Â  let chapters = [];
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(apiPath, { headers: { Accept: 'application/vnd.github.v3+json' } });
Â  Â  Â  Â  if (!res.ok) throw new Error(`API ${res.status}`);
Â  Â  Â  Â  const items = await res.json();
Â  Â  Â  Â  // filter directories only
Â  Â  Â  Â  chapters = items.filter(it => it.type === 'dir').map(it => it.name).sort();
Â  Â  } catch (e) {
Â  Â  Â  Â  // API failed (rate limit or other) -> fallback: if initialChapter present, use that only
Â  Â  Â  Â  console.warn('KhÃ´ng láº¥y Ä‘Æ°á»£c danh sÃ¡ch chap tá»« GitHub API:', e);
Â  Â  }

Â  Â  if (chapters.length > 0) {
Â  Â  Â  Â  // populate select
Â  Â  Â  Â  chapterSelect.innerHTML = '';
Â  Â  Â  Â  chapters.forEach(ch => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = ch;
Â  Â  Â  Â  Â  Â  opt.textContent = ch;
Â  Â  Â  Â  Â  Â  chapterSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  // if initialChapter exists, try set it; otherwise select first
Â  Â  Â  Â  if (initialChapter) {
Â  Â  Â  Â  Â  Â  const want = initialChapter;
Â  Â  Â  Â  Â  Â  const foundOpt = Array.from(chapterSelect.options).find(o => o.value === want);
Â  Â  Â  Â  Â  Â  if (foundOpt) chapterSelect.value = want;
Â  Â  Â  Â  }
Â  Â  Â  Â  chapterControlsEl.style.display = 'flex';
Â  Â  Â  Â  // event handlers
Â  Â  Â  Â  loadChapterBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  const sel = chapterSelect.value;
Â  Â  Â  Â  Â  Â  loadComicPagesClean(`${comicBase}/${sel}`);
Â  Â  Â  Â  };
Â  Â  Â  Â  reloadBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  const sel = chapterSelect.value;
Â  Â  Â  Â  Â  Â  // clear images then reload same chapter
Â  Â  Â  Â  Â  Â  loadComicPagesClean(`${comicBase}/${sel}`, true);
Â  Â  Â  Â  };

Â  Â  Â  Â  // auto-load selected chapter immediately
Â  Â  Â  Â  const selectedValue = chapterSelect.value;
Â  Â  Â  Â  loadComicPagesClean(`${comicBase}/${selectedValue}`);
Â  Â  } else {
Â  Â  Â  Â  // no chapter list from API: fallback to folderParam (if it includes chap), else try to load Chap1
Â  Â  Â  Â  if (initialChapter) {
Â  Â  Â  Â  Â  Â  loadComicPagesClean(`${comicBase}/${initialChapter}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // try Chap1 by default (common pattern)
Â  Â  Â  Â  Â  Â  loadComicPagesClean(`${comicBase}/Chap1`);
Â  Â  Â  Â  }
Â  Â  Â  Â  // controls remain hidden if chapters not available
Â  Â  }
}

/* ================= LOAD IMAGES (clean mode) =================
Â  Â - folderName should be like "YugiOh/Chap1"
Â  Â - only append images that successfully loaded
*/
async function loadComicPagesClean(folderName, forceReload = false) {
Â  Â  const viewer = document.getElementById('viewerContainer');
Â  Â  // if forceReload true clear existing images first
Â  Â  viewer.innerHTML = '<p id="status-viewer">Äang tÃ¬m vÃ  táº£i cÃ¡c trang truyá»‡n...</p>';
Â  Â  const statusViewerEl = document.getElementById('status-viewer');

Â  Â  let pagesLoaded = 0;
Â  Â  let consecutiveMisses = 0;
Â  Â  const maxConsecutiveMisses = 10;

Â  Â  for (let i = 0; i < MAX_PAGES; i++) {
Â  Â  Â  Â  const pageNumber = i.toString().padStart(5, '0');

Â  Â  Â  Â  // absolute URLs to avoid relative path issues
Â  Â  Â  Â  const jpgUrl = encodeURI(`${BASE_PATH}${COMIC_ROOT_FOLDER}${folderName}/${pageNumber}.jpg`);
Â  Â  Â  Â  const pngUrl = encodeURI(`${BASE_PATH}${COMIC_ROOT_FOLDER}${folderName}/${pageNumber}.png`);

Â  Â  Â  Â  // try jpg then png
Â  Â  Â  Â  let found = false;
Â  Â  Â  Â  if (await tryLoadImageIntoViewer(jpgUrl, viewer)) {
Â  Â  Â  Â  Â  Â  found = true;
Â  Â  Â  Â  } else if (await tryLoadImageIntoViewer(pngUrl, viewer)) {
Â  Â  Â  Â  Â  Â  found = true;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (found) {
Â  Â  Â  Â  Â  Â  pagesLoaded++;
Â  Â  Â  Â  Â  Â  consecutiveMisses = 0;
Â  Â  Â  Â  Â  Â  statusViewerEl.textContent = `Äang táº£i ${pagesLoaded} trang...`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  consecutiveMisses++;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (pagesLoaded > 0 && consecutiveMisses >= maxConsecutiveMisses) {
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (i > 1000 && pagesLoaded === 0) break;
Â  Â  }

Â  Â  if (pagesLoaded === 0) {
Â  Â  Â  Â  viewer.innerHTML = `<p class="error">âŒ KhÃ´ng tÃ¬m tháº¥y trang truyá»‡n nÃ o. Kiá»ƒm tra:Â 
Â  Â  Â  Â  Â  Â  <br>1) ThÆ° má»¥c <strong>book/Comic/${folderName}</strong> Ä‘Ã£ push chÆ°a?
Â  Â  Â  Â  Â  Â  <br>2) TÃªn folder/file phÃ¢n biá»‡t chá»¯ hoa/thÆ°á»ng?
Â  Â  Â  Â  Â  Â  <br>3) File áº£nh cÃ³ tÃªn dáº¡ng <strong>00000.jpg</strong>, <strong>00001.jpg</strong>, ...?</p>`;
Â  Â  } else {
Â  Â  Â  Â  statusViewerEl.textContent = `âœ… HoÃ n táº¥t táº£i ${pagesLoaded} trang.`;
Â  Â  }
}

// append image only if it loads successfully
function tryLoadImageIntoViewer(url, viewer) {
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  let resolved = false;
Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  if (resolved) return;
Â  Â  Â  Â  Â  Â  resolved = true;
Â  Â  Â  Â  Â  Â  // append image element (use created Image, which is already loaded)
Â  Â  Â  Â  Â  Â  img.className = 'comic-page';
Â  Â  Â  Â  Â  Â  viewer.appendChild(img);
Â  Â  Â  Â  Â  Â  resolve(true);
Â  Â  Â  Â  };
Â  Â  Â  Â  img.onerror = () => {
Â  Â  Â  Â  Â  Â  if (resolved) return;
Â  Â  Â  Â  Â  Â  resolved = true;
Â  Â  Â  Â  Â  Â  resolve(false);
Â  Â  Â  Â  };
Â  Â  Â  Â  img.src = url;
Â  Â  Â  Â  // safety timeout fallback
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (resolved) return;
Â  Â  Â  Â  Â  Â  resolved = true;
Â  Â  Â  Â  Â  Â  resolve(false);
Â  Â  Â  Â  }, 8000);
Â  Â  });
}

/* ================= BACK LINK ================= */
document.getElementById('backLink').addEventListener('click', function(e) {
Â  Â  e.preventDefault();
Â  Â  window.location.href = 'index.html';
});
</script>
</body>
</html>