<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truy·ªán Tranh Online</title>
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; background-color: #f4f7f6; color: #333; }
        
        /* C·∫≠p nh·∫≠t Header ƒë·ªÉ ch·ª©a Controls */
        header { 
            background:#3498db; 
            color:#fff; 
            padding:20px; 
            box-shadow:0 2px 4px rgba(0,0,0,.1); 
            position:relative; 
        }
        
        #headerContent {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between; /* ƒê·∫©y hai nh√≥m n·ªôi dung ra hai b√™n */
            align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            text-align: left;
        }

        #titleGroup h1 { 
            margin:0; 
            font-size: 2.2em;
        }
        #titleGroup #subText {
            margin: 5px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Controls (N√∫t T·∫£i) b√™n ph·∫£i Header */
        #headerControls {
            display: flex;
            flex-direction: column; 
            align-items: flex-end; /* CƒÉn ph·∫£i n√∫t v√† status */
            min-width: 150px; 
        }

        #loadComicsBtn { 
            background:#2ecc71; 
            color:#fff; 
            padding:8px 12px; 
            border:none; 
            border-radius:5px; 
            cursor:pointer; 
            font-size:14px; 
            transition:background .2s; 
            margin-bottom: 5px; 
        }
        #loadComicsBtn:hover {
            background: #27ae60;
        }
        
        #status { 
            margin: 0; 
            font-style:italic; 
            color:#fff; 
            font-size: 0.9em;
        }

        main { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* N√∫t Quay L·∫°i */
        .back-link {
            position: absolute;
            top: 10px;
            left: 20px;
            color: #fff;
            text-decoration: none;
            font-size: 1em;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        .back-link:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* Comic List Grid */
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 30px; }

        #comicsContainer { 
            display:grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap:20px; 
            margin-top:20px; 
        }
        .comic-item { 
            background:#fff; 
            border:1px solid #ddd; 
            border-radius:8px; 
            box-shadow:0 2px 5px rgba(0,0,0,.05); 
            overflow:hidden; 
            transition:transform .2s;
            text-align: center; 
        }
        .comic-item:hover { 
            transform:translateY(-5px); 
            box-shadow:0 8px 15px rgba(0,0,0,.1);
        }
        .comic-item a { 
            display:block; 
            padding:10px; 
            text-decoration:none; 
            color:inherit; 
        }
        .comic-cover {
            width: 100%;
            height: 250px; 
            object-fit: cover; 
            border-radius: 5px;
            margin-bottom: 8px;
            display: block;
            box-shadow: 0 0 5px rgba(0,0,0,.1);
        }
        .comic-item h3 { 
            color:#3498db; 
            margin:0 0 5px 0; 
            font-size: 1.1em;
        }
        .comic-item p {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 0;
        }


        /* Viewer Controls */
        #viewerControls {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
        }
        #chapterSelect {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-width: 120px;
        }
        #reloadBtn {
            background: #3498db;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s;
        }
        #reloadBtn:hover {
            background: #2980b9;
        }

        /* Comic Viewer */
        #viewerContainer {
            text-align: center;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
        }
        .comic-page-container {
            margin: 10px 0;
            display: inline-block; /* Quan tr·ªçng ƒë·ªÉ cƒÉn gi·ªØa ·∫£nh */
            max-width: 100%;
        }
        .comic-page {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
        }
        .error-icon {
            color: #c0392b; 
            font-weight: bold; 
            margin-top: 5px; 
            display: block;
            text-align: center;
        }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="backLink" style="display:none;" class="back-link">&larr; Quay l·∫°i Danh s√°ch</a>
    <div id="headerContent">
        <div id="titleGroup">
            <h1 id="mainTitle">Truy·ªán Tranh Online</h1>
				    <p id="subText">Kho l∆∞u tr·ªØ truy·ªán tranh c√° nh√¢n tr√™n GitHub</p>
        </div>
        <div id="headerControls" style="display:none;">
            </div>
    </div>
</header>

<main>
    <div id="controls" style="display: none;"> 
        		</div>

    <div id="comicList">
        <h2>Danh S√°ch Truy·ªán</h2>
        <div id="comicsContainer">
            </div>
    </div>

    <div id="comicViewer" style="display:none;">
        <div id="viewerControls">
            <label for="chapterSelect">Ch·ªçn Chap:</label>
            <select id="chapterSelect"></select>
            <button id="reloadBtn">Reload Images</button>
            <span id="apiStatus" style="color: #c0392b;"></span>
        </div>
        <div id="viewerContainer">
            </div>
    </div>
</main>

<script>
/* ================= C·∫§U H√åNH ================= */
const GITHUB_CONFIG = {
		OWNER: 'huynt89',
		REPO: 'Book',				
		ROOT_DIR: '',				
		COMIC_DIR: 'Comic'		
};

// ‚≠êÔ∏è C·∫¨P NH·∫¨T: Th√™m tr∆∞·ªùng "cover" v√† th∆∞ m·ª•c "img/"
const COMIC_DATA_JSON = [
		{
				"title": "Truy·ªán Yugi-Oh",
				"folder": "YugiOh",	
				"upload_date": "2025-11-16",
				"description": "Vua Tr√≤ Ch∆°i Yugi-Oh",
				"cover": "img/YugiOh_cover.jpg" 
		},
    {
				"title": "Th√°m T·ª≠ L·ª´ng Danh Conan",
				"folder": "Conan",	
				"upload_date": "2025-11-16",
				"description": "B·∫£n s∆∞u t·∫≠p 100 t·∫≠p truy·ªán",
				"cover": "img/Conan_cover.jpg" 
		}
		{
				"title": "7 Vi√™n Ng·ªçc R·ªìng",
				"folder": "7vienngocrong",	
				"upload_date": "2025-11-16",
				"description": "Full truy·ªán 7 vi√™n ng·ªçc r·ªìng",
				"cover": "img/7vienngocrong_cover.jpg" 
		}
    // Th√™m c√°c truy·ªán kh√°c n·∫øu c·∫ßn
];

/* ================= H√ÄM H·ªñ TR·ª¢ PATH ================= */
function getBaseImagePath() {
		const origin = window.location.origin;	
		const pathname = window.location.pathname;
		// Gi·∫£ s·ª≠ th∆∞ m·ª•c g·ªëc l√† /Book/
		if(pathname.includes('/Book/')) return origin + '/Book/';
		// N·∫øu kh√¥ng c√≥ /Book/ (v√≠ d·ª•: ƒëang ·ªü repo root), d√πng path hi·ªán t·∫°i
		return origin + pathname.substring(0, pathname.lastIndexOf('/') + 1);
}
const BASE_PATH = getBaseImagePath();

/* ================= KH·ªûI T·∫†O & CONTROLS ================= */
let currentComicBase = '';
let currentChapterPath = '';

document.addEventListener('DOMContentLoaded', initializePage);

function initializePage() {
    // ‚≠êÔ∏è DI CHUY·ªÇN N√öT V√Ä STATUS V√ÄO HEADER
    const headerControlsDiv = document.getElementById('headerControls');
    const loadComicsBtn = document.createElement('button');
    loadComicsBtn.id = 'loadComicsBtn';
    loadComicsBtn.textContent = 'üîÑ T·∫£i Danh S√°ch Truy·ªán';
    const statusEl = document.createElement('p');
    statusEl.id = 'status';

    headerControlsDiv.appendChild(loadComicsBtn);
    headerControlsDiv.appendChild(statusEl);
    headerControlsDiv.style.display = 'flex'; // Hi·ªán l·∫°i controls trong header

		const params = new URLSearchParams(window.location.search);
		const folderParam = params.get('folder');	
		
		// B·∫Øt s·ª± ki·ªán khi thay ƒë·ªïi chapter
		const chapterSelect = document.getElementById('chapterSelect');
		chapterSelect.addEventListener('change', (e) => {
				const selectedChapter = e.target.value;
				if (currentComicBase && selectedChapter) {
						loadComicPagesFast(`${currentComicBase}/${selectedChapter}`);
				}
		});
		
		// B·∫Øt s·ª± ki·ªán Reload Images
		document.getElementById('reloadBtn').onclick = reloadFailedImages;

		if (folderParam) {
				showViewerPage(decodeURIComponent(folderParam));
		} else {
				showListPage();
		}
}

/* ================= LIST PAGE ================= */
function showListPage() {
		document.getElementById('backLink').style.display = 'none';
		document.getElementById('mainTitle').textContent = 'Truy·ªán Tranh Online';
		document.getElementById('comicViewer').style.display = 'none';
		document.getElementById('comicList').style.display = 'block';
    // Hi·ªÉn th·ªã controls trong header khi ·ªü trang danh s√°ch
    document.getElementById('headerControls').style.display = 'flex'; 

		const loadBtn = document.getElementById('loadComicsBtn');
		loadBtn.removeEventListener('click', loadComics);
		loadBtn.addEventListener('click', loadComics);
		loadComics();	
}

function loadComics() {
		const comicsContainer = document.getElementById('comicsContainer');
		const statusEl = document.getElementById('status');
		const comics = COMIC_DATA_JSON;
		comicsContainer.innerHTML = '';
			
		const basePath = getBaseImagePath();

		comics.forEach(comic => {
				const comicDiv = document.createElement('div');
				comicDiv.classList.add('comic-item');
				const comicLink = document.createElement('a');
				comicLink.href = `index.html?folder=${encodeURIComponent(comic.folder)}`;
				
				// T·∫°o ƒë∆∞·ªùng d·∫´n cover ƒë·∫ßy ƒë·ªß: basePath + comic.cover
				const coverSrc = comic.cover ? basePath + comic.cover : 'placeholder.png'; // Thay 'placeholder.png' b·∫±ng ·∫£nh m·∫∑c ƒë·ªãnh n·∫øu c·∫ßn
				
				comicLink.innerHTML = `
            <img src="${coverSrc}" alt="${comic.title} Cover" class="comic-cover">
						<h3>${comic.title}</h3>
						<p>${comic.description}</p>
						<p class="view-link" style="margin-top: 5px;">Xem ngay &rarr;</p>
				`;
				comicDiv.appendChild(comicLink);
				comicsContainer.appendChild(comicDiv);
		});
		statusEl.textContent = `‚úÖ ƒê√£ t·∫£i: ${comics.length} truy·ªán.`;
}

/* ================= VIEWER PAGE (INIT) ================= */
async function showViewerPage(folderParam) {
    // ·∫®n controls list
    document.getElementById('headerControls').style.display = 'none'; 
		document.getElementById('comicList').style.display = 'none';
		document.getElementById('comicViewer').style.display = 'block';
		document.getElementById('backLink').style.display = 'block';

		const parts = folderParam.split('/').filter(Boolean);
		currentComicBase = parts[0];	
		const initialChapter = parts.length > 1 ? parts.slice(1).join('/') : '';

		const currentComic = COMIC_DATA_JSON.find(c => c.folder === currentComicBase);
		document.getElementById('mainTitle').textContent = currentComic ? currentComic.title : currentComicBase;
    document.getElementById('subText').textContent = currentComic ? currentComic.description : 'ƒêang t·∫£i ch∆∞∆°ng...';

		const chapterSelect = document.getElementById('chapterSelect');
		const apiStatus = document.getElementById('apiStatus');
			
		chapterSelect.innerHTML = '<option>ƒêang t√¨m Chap...</option>';
		apiStatus.textContent = 'ƒêang k·∫øt n·ªëi...';

		const path = [GITHUB_CONFIG.ROOT_DIR, GITHUB_CONFIG.COMIC_DIR, currentComicBase].filter(p => p).join('/');
		const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${path}`;

		let chapters = [];

		try {
				const res = await fetch(apiUrl);
				if (!res.ok) {
						throw new Error("L·ªói k·∫øt n·ªëi API");	
				}
				const items = await res.json();
				chapters = items
						.filter(item => item.type === 'dir' && item.name.toLowerCase().startsWith('chap'))
						.map(item => item.name)
						.sort((a, b) => {
								const numA = parseInt((a.match(/\d+/) || [0])[0]);
								const numB = parseInt((b.match(/\d+/) || [0])[0]);
								return numA - numB;
						});
				apiStatus.textContent = '';	
		} catch (e) {
				console.error(e);
				apiStatus.innerHTML = ``;
		}

		chapterSelect.innerHTML = '';	

		if (chapters.length > 0) {
				chapters.forEach(ch => {
						const opt = document.createElement('option');
						opt.value = ch;
						opt.textContent = ch;
						chapterSelect.appendChild(opt);
				});
				let chapterToLoad = chapters[0];
				if (initialChapter && chapters.includes(initialChapter)) {
						chapterSelect.value = initialChapter;
						chapterToLoad = initialChapter;
				} else {
						chapterSelect.selectedIndex = 0;
				}
				// T·ª± ƒë·ªông load chapter khi kh·ªüi t·∫°o
				loadComicPagesFast(`${currentComicBase}/${chapterToLoad}`);
		} else {
				apiStatus.textContent = 'Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng n√†o.';
        // V·∫´n g·ªçi load ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o "Kh√¥ng t√¨m th·∫•y ·∫£nh" n·∫øu c·∫ßn
				loadComicPagesFast(`${currentComicBase}/Chap0001`); 
		}
}


/* ================= LOAD ·∫¢NH B·∫∞NG API (KH√îNG D√ôNG V√íNG L·∫∂P ƒêO√ÅN) ================= */
async function loadComicPagesFast(folderPath) {
    currentChapterPath = folderPath; 
		const viewer = document.getElementById('viewerContainer');
		const statusViewerEl = createOrGetStatusElement(viewer);
		viewer.innerHTML = ''; 
		viewer.appendChild(statusViewerEl);
    
		statusViewerEl.textContent = 'üöÄ ƒêang t·∫£i danh s√°ch ·∫£nh...';

		const [comicBase, chapterFolder] = folderPath.split('/');
		const fullPath = [GITHUB_CONFIG.ROOT_DIR, GITHUB_CONFIG.COMIC_DIR, comicBase, chapterFolder].filter(p => p).join('/');
		const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${fullPath}`;

		try {
				const res = await fetch(apiUrl);
				if (!res.ok) {
						throw new Error(`GitHub API Error: ${res.statusText}`);
				}
				const items = await res.json();
				
				// 1. L·ªçc v√† S·∫Øp x·∫øp t√™n file ·∫£nh
				const imageFiles = items
						.filter(item => item.type === 'file' && (item.name.endsWith('.jpg') || item.name.endsWith('.png') || item.name.endsWith('.webp'))) // Th√™m .webp n·∫øu c·∫ßn
						.map(item => item.name)
						.sort((a, b) => {
								const numA = parseInt(a.match(/\d+/)?.[0] || '0');
								const numB = parseInt(b.match(/\d+/)?.[0] || '0');
								return numA - numB;
						});

				if (imageFiles.length === 0) {
						statusViewerEl.textContent = `Kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ file ·∫£nh n√†o trong ch∆∞∆°ng ${chapterFolder}.`;
						return;
				}

				// 2. T·∫°o URL c∆° s·ªü v√† hi·ªÉn th·ªã ·∫£nh
				const baseContentUrl = `${BASE_PATH}${GITHUB_CONFIG.COMIC_DIR}/${folderPath}/`;
				
				const fragment = document.createDocumentFragment();
				imageFiles.forEach((fileName, index) => {
						const imgContainer = document.createElement('div');
						imgContainer.className = 'comic-page-container';
						
						const img = new Image();
						img.className = 'comic-page';
						img.alt = `Trang ${index + 1} (${fileName})`;
						img.src = baseContentUrl + fileName;
            img.dataset.status = 'loading'; 

            img.onload = function() {
                this.dataset.status = 'loaded';
                // X√≥a icon l·ªói n·∫øu c√≥
                const errorIcon = this.nextElementSibling;
                if(errorIcon && errorIcon.classList.contains('error-icon')) {
                    errorIcon.remove();
                }
            };

            img.onerror = function() {
                this.dataset.status = 'failed';
                // Th√™m icon l·ªói (X)
                let errorIcon = this.nextElementSibling;
                if (!errorIcon || !errorIcon.classList.contains('error-icon')) {
                    errorIcon = document.createElement('span');
                    errorIcon.className = 'error-icon';
                    errorIcon.textContent = '‚ùå L·ªói t·∫£i ·∫£nh';
                    errorIcon.style.cssText = 'color: #c0392b; font-weight: bold; margin-top: 5px; display: block; text-align: center;';
                    this.parentNode.insertBefore(errorIcon, this.nextSibling);
                }
            };
						
						imgContainer.appendChild(img);
						fragment.appendChild(imgContainer);
				});

				// 3. Hi·ªÉn th·ªã t·∫•t c·∫£ ·∫£nh c√πng l√∫c v√† x√≥a status
				viewer.insertBefore(fragment, statusViewerEl);
				statusViewerEl.textContent = ''; 

		} catch (e) {
				console.error("L·ªói khi t·∫£i trang b·∫±ng API:", e);
				statusViewerEl.textContent = `‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i danh s√°ch file cho ch∆∞∆°ng ${chapterFolder}.`;
		}
}

// H√†m h·ªó tr·ª£ t·∫°o/l·∫•y status element (gi·ªØ nguy√™n)
function createOrGetStatusElement(viewer) {
    let statusViewerEl = document.getElementById('status-viewer');
    if (!statusViewerEl) {
        statusViewerEl = document.createElement('p');
        statusViewerEl.id = 'status-viewer';
        statusViewerEl.style.color = '#777';
        statusViewerEl.style.fontStyle = 'italic';
        statusViewerEl.style.textAlign = 'center';
    }
    return statusViewerEl;
}

/* ================= CH·ª®C NƒÇNG RELOAD L·ªñI ================= */
function reloadFailedImages() {
    const viewer = document.getElementById('viewerContainer');
    const statusViewerEl = createOrGetStatusElement(viewer);
    
    // T√¨m t·∫•t c·∫£ c√°c th·∫ª <img> c√≥ thu·ªôc t√≠nh data-status="failed"
    const failedImages = viewer.querySelectorAll('img[data-status="failed"]');
    
    if (failedImages.length === 0) {
        statusViewerEl.textContent = 'üéâ Kh√¥ng c√≥ ·∫£nh n√†o b·ªã l·ªói c·∫ßn t·∫£i l·∫°i.';
        setTimeout(() => statusViewerEl.textContent = '', 3000);
        return;
    }

    statusViewerEl.textContent = `üîÑ ƒêang t·∫£i l·∫°i ${failedImages.length} ·∫£nh b·ªã l·ªói...`;

    let reloadCount = 0;
    failedImages.forEach(img => {
        // ƒê·∫∑t l·∫°i tr·∫°ng th√°i
        img.dataset.status = 'loading'; 
        
        // Bu·ªôc tr√¨nh duy·ªát t·∫£i l·∫°i ·∫£nh: g√°n src r·ªóng sau ƒë√≥ g√°n l·∫°i src g·ªëc
        const originalSrc = img.src;
        img.src = ''; 
        img.src = originalSrc; 
        reloadCount++;
    });

    if (reloadCount > 0) {
        // D√πng setTimeout ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i sau khi c√°c ·∫£nh ƒë√£ c√≥ th·ªùi gian load
        setTimeout(() => {
            const stillFailed = viewer.querySelectorAll('img[data-status="failed"]').length;
            if (stillFailed === 0) {
                statusViewerEl.textContent = `‚úÖ T·∫£i l·∫°i th√†nh c√¥ng!`;
            } else {
                statusViewerEl.textContent = `‚ö†Ô∏è V·∫´n c√≤n ${stillFailed} ·∫£nh ch∆∞a t·∫£i ƒë∆∞·ª£c. Th·ª≠ l·∫°i sau.`;
            }
            setTimeout(() => statusViewerEl.textContent = '', 3000); 
        }, 2000); // 2 gi√¢y ch·ªù load l·∫°i
    }
}


/* ================= BACK LINK ================= */
document.getElementById('backLink').addEventListener('click', function(e) {
		e.preventDefault();
		window.location.href = 'index.html';
});
</script>

</body>
</html>